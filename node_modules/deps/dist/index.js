"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const execa_1 = __importDefault(require("execa"));
const tempy_1 = __importDefault(require("tempy"));
const assert_1 = __importDefault(require("assert"));
const del_1 = __importDefault(require("del"));
const analyze_reports_1 = __importDefault(require("./analyze-reports"));
const output_result_1 = __importDefault(require("./output-result"));
async function deps(cmd, options) {
    assert_1.default(cmd, 'A command must be passed in');
    let coverageDir;
    let useExitcode = 0;
    if (cmd === 'analyze') {
        coverageDir = process.env.NODE_V8_COVERAGE;
        assert_1.default(coverageDir, 'Recording not started. Start by running `. deps-record`');
    }
    else {
        coverageDir = tempy_1.default.directory();
        const result = await execa_1.default.command(cmd, {
            reject: false,
            stdio: 'inherit',
            env: {
                NODE_V8_COVERAGE: coverageDir,
            },
        });
        useExitcode = result.exitCode;
    }
    const usedDependencies = await analyze_reports_1.default(coverageDir);
    await output_result_1.default(usedDependencies, options);
    if (cmd !== 'analyze') {
        await del_1.default([coverageDir], { force: true });
    }
    return useExitcode;
}
exports.default = deps;
